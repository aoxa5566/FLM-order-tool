<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FLMè¨‚è²¨è¼”åŠ©å·¥å…·</title>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        margin: 0;
        padding: 10px;
        background: #f9f9f9;
      }

      .container {
        max-width: 700px;
        margin: auto;
        padding: 10px;
      }

      h2 {
        text-align: center;
        font-size: 24px;
        margin-bottom: 20px;
        color: #333;
      }

      label {
        display: block;
        margin-top: 15px;
        font-size: 16px;
        color: #555;
      }

      select,
      input[type="date"],
      input[type="number"],
      textarea {
        width: 100%;
        padding: 10px;
        margin-top: 6px;
        box-sizing: border-box;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 6px;
        background: #fff;
        transition: border-color 0.3s;
      }

      select:focus,
      input:focus,
      textarea:focus {
        border-color: #4a90e2;
        outline: none;
      }

      h3 {
        margin-top: 30px;
        border-bottom: 1px solid #ccc;
        padding: 15px;
        cursor: pointer;
        background-color: #4a90e2;
        color: #fff;
        user-select: none;
        font-size: 18px;
        border-radius: 6px 6px 0 0;
      }

      .item-list {
        padding: 10px 0;
        display: none;
      }

      .item {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        align-items: center;
        background: #fff;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        transition: background 0.3s;
      }

      .item:hover {
        background: #e6f0ff;
      }

      .item label {
        display: flex;
        flex-direction: column;
        gap: 5px;
        width: 100%;
      }

      input[type="number"] {
        width: 100px;
        padding: 6px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }

      .calc-box {
        margin-left: 10px;
        color: #4a90e2;
        font-size: 14px;
      }

      /* å›ºå®šåº•éƒ¨æŒ‰éˆ•å®¹å™¨ */
      .button-container {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        max-width: 700px;
        margin: auto;
        padding: 10px;
        background: #f9f9f9;
        display: flex;
        gap: 10px;
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        z-index: 999;
        box-sizing: border-box;
      }

      .button-container button {
        flex: 1;
        font-size: 18px;
        padding: 12px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        color: #fff;
        transition: background 0.3s;
      }

      #complete-btn {
        background: linear-gradient(90deg, #4a90e2, #357abd);
      }

      #complete-btn:hover {
        background: linear-gradient(90deg, #357abd, #285c8a);
      }

      #copy-btn {
        background: linear-gradient(90deg, #50c878, #3ea864);
      }

      #copy-btn:hover {
        background: linear-gradient(90deg, #3ea864, #33714f);
      }

      #scroll-top-btn {
        flex: 0 0 60px;
        font-size: 18px;
        padding: 10px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        color: #fff;
        background: linear-gradient(90deg, #4a90e2, #357abd);
        transition: background 0.3s, transform 0.2s;
      }

      #scroll-top-btn:hover {
        transform: translateY(-2px);
        background: linear-gradient(90deg, #357abd, #285c8a);
      }

      #order-summary {
        white-space: pre-wrap;
        background: #fff;
        padding: 15px;
        margin-top: 20px;
        border-radius: 8px;
        font-family: monospace;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      /* æ‰‹æ©Ÿå°ˆç”¨èª¿æ•´ */
      @media (max-width: 480px) {
        .item {
          flex-direction: column;
          align-items: flex-start;
        }

        input[type="number"] {
          width: 100%;
        }

        h2 {
          font-size: 20px;
        }

        h3 {
          font-size: 16px;
          padding: 12px;
        }
        .button-container {
          flex-direction: row; /* æ”¹å›æ°´å¹³æ’åˆ— */
          justify-content: space-between;
        }
        .button-container button {
          font-size: 14px;
          padding: 8px;
        }
        #scroll-top-btn {
          width: 40px;
          height: 40px;
          font-size: 16px;
        }
        .button-container {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          gap: 8px;
          position: fixed;
          bottom: 10px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(255, 255, 255, 0.8);
          padding: 10px;
          border-radius: 16px;
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
          z-index: 100;
        }
      }
    </style>
  </head>
  <body>
    <h2>FLMè¨‚è²¨è¼”åŠ©å·¥å…·</h2>

    <label for="store-select">è«‹é¸æ“‡åº—å®¶ï¼š</label>
    <select id="store-select" onchange="filterItems()">
      <option value="">-- è«‹é¸æ“‡åº—å®¶ --</option>
      <option value="æ¼¢ç¥åº—">æ¼¢ç¥åº—</option>
      <option value="å·¨è›‹åº—">å·¨è›‹åº—</option>
    </select>

    <label for="order-date">è¨‚è²¨æ—¥æœŸï¼š</label>
    <input type="date" id="order-date" />

    <label for="remark">å‚™è¨»ï¼š</label>
    <textarea id="remark" rows="3" placeholder="è«‹è¼¸å…¥å‚™è¨»..."></textarea>

    <input
      type="text"
      id="search"
      placeholder="ğŸ” æœå°‹å•†å“åç¨±ã€è¦æ ¼ã€å–®ä½..."
      oninput="filterItems()"
    />

    <!-- å±•é–‹/æ”¶åˆå…¨éƒ¨æŒ‰éˆ• -->
    <div style="margin: 10px 0; text-align: right">
      <button
        onclick="expandAll()"
        style="padding: 6px 12px; margin-right: 6px"
      >
        å±•é–‹å…¨éƒ¨
      </button>
      <button onclick="collapseAll()" style="padding: 6px 12px">
        æ”¶åˆå…¨éƒ¨
      </button>
    </div>

    <div id="product-list"></div>

    <div class="button-container">
      <button id="complete-btn" onclick="generateSummary()">
        å®Œæˆè¨‚å–®ä¸¦é¡¯ç¤ºå…§å®¹
      </button>
      <button id="copy-btn" onclick="copySummary()" style="display: none">
        è¤‡è£½è¨‚å–®å…§å®¹
      </button>
      <button id="scroll-top-btn" title="å›åˆ°æœ€ä¸Šæ–¹">â¬†ï¸</button>
    </div>

    <pre id="order-summary"></pre>
    <script>
      const sheetApiBase =
        "https://opensheet.vercel.app/1uzqHTQxyhYxTtU6SNbgme46i3rrjyUDfj4iq9IFQjFY/";
      const sheetIds = ["å†·å‡é¡", "å¸¸æº«/åŒ…æé¡", "æ–‡å…·/å…¶ä»–é¡", "æ¸…æ½”ç”¨å“é¡"];
      let allItems = [];
      const expandStatus = {};

      document.getElementById("order-date").valueAsDate = new Date();

      async function loadProducts() {
        const container = document.getElementById("product-list");
        container.innerHTML = "";
        allItems = [];
        sheetIds.forEach((sheet) => (expandStatus[sheet] = false));

        for (const sheetName of sheetIds) {
          try {
            const encodedSheet = encodeURIComponent(sheetName);
            const res = await fetch(`${sheetApiBase}${encodedSheet}`);
            const data = await res.json();

            const section = document.createElement("section");
            const title = document.createElement("h3");
            title.textContent = sheetName;
            title.onclick = () => {
              expandStatus[sheetName] = !expandStatus[sheetName];
              updateSectionDisplay(sheetName);
            };

            const listDiv = document.createElement("div");
            listDiv.className = "item-list";

            data.forEach((item) => {
              const boxCount = parseInt(item.ç®±å…¥æ•¸, 10) || null;

              const div = document.createElement("div");
              div.className = "item";
              div.setAttribute("data-name", item.name || "");
              div.setAttribute("data-spec", item.è¦æ ¼ || "");
              div.setAttribute("data-unit", item.å–®ä½ || "");
              div.setAttribute("data-category", sheetName);
              div.setAttribute("data-boxcount", boxCount || "");

              // è¨­å®šå¤šåº—å€åŸŸå±¬æ€§ï¼ˆæ”¯æ´å·¨è›‹åº—ã€æ¼¢ç¥åº—ã€ç¬¬ä¸‰åº—ç­‰ï¼‰
              Object.keys(item).forEach((key) => {
                if (["æ¼¢ç¥åº—", "å·¨è›‹åº—", "ç¬¬ä¸‰åº—"].includes(key)) {
                  div.setAttribute(`data-${key}`, item[key] || "ç„¡");
                }
              });

              div.innerHTML = `
                <label>
                  <span>${item.name}ï¼ˆè¦æ ¼:${item.è¦æ ¼ || ""} / å–®ä½:${
                item.å–®ä½ || ""
              }ï¼‰</span><br>
                  æ•¸é‡: <input type="number" min="0" value="0" class="pcs-input" style="width:80px">
                  <span class="calc-box"></span>
                </label>
              `;

              const pcsInput = div.querySelector(".pcs-input");
              const calcSpan = div.querySelector(".calc-box");

              pcsInput.addEventListener("input", () => {
                const qty = parseInt(pcsInput.value, 10) || 0;
                let text = "";
                if (boxCount) {
                  const boxes = Math.floor(qty / boxCount);
                  const remainder = qty % boxCount;
                  if (boxes > 0) text += `${boxes}ç®± `;
                  if (remainder > 0) text += `${remainder}${item.å–®ä½}`;
                } else {
                  if (qty > 0) text = `${qty}${item.å–®ä½}`;
                }
                calcSpan.textContent = text;
              });

              listDiv.appendChild(div);
              allItems.push({ element: div, category: sheetName });
            });

            section.appendChild(title);
            section.appendChild(listDiv);
            container.appendChild(section);
            updateSectionDisplay(sheetName);
          } catch (err) {
            const errorDiv = document.createElement("div");
            errorDiv.className = "error";
            errorDiv.innerText = `âŒ ç„¡æ³•è¼‰å…¥ã€Œ${sheetName}ã€ï¼Œè«‹æª¢æŸ¥åˆ†é åç¨±æˆ–ç¶²è·¯`;
            container.appendChild(errorDiv);
            console.error(`âŒ è¼‰å…¥éŒ¯èª¤ï¼š${sheetName}`, err);
          }
        }
      }

      function updateSectionDisplay(sheetName) {
        const section = [...document.querySelectorAll("section")].find(
          (sec) => sec.querySelector("h3").textContent === sheetName
        );
        if (!section) return;
        const listDiv = section.querySelector(".item-list");
        listDiv.style.display = expandStatus[sheetName] ? "block" : "none";
      }

      function expandAll() {
        sheetIds.forEach((sheet) => {
          expandStatus[sheet] = true;
          updateSectionDisplay(sheet);
        });
      }

      function collapseAll() {
        sheetIds.forEach((sheet) => {
          expandStatus[sheet] = false;
          updateSectionDisplay(sheet);
        });
      }

      // âœ… æ”¹è‰¯å¾Œï¼šä¾é¸æ“‡çš„åº—å®¶é¡¯ç¤ºæ­£ç¢ºå€åŸŸ
      function filterItems() {
        const store = document.getElementById("store-select").value.trim();
        const keyword = document.getElementById("search").value.toLowerCase();
        const matchedCategories = new Set();

        allItems.forEach(({ element, category }) => {
          const areaField = element.getAttribute(`data-${store}`) || "ç„¡";
          const name = element.getAttribute("data-name").toLowerCase();
          const spec = element.getAttribute("data-spec").toLowerCase();
          const unit = element.getAttribute("data-unit").toLowerCase();

          const matchesStore = store ? areaField !== "ç„¡" : true;
          const matchesSearch =
            name.includes(keyword) ||
            spec.includes(keyword) ||
            unit.includes(keyword);

          const matched = matchesStore && matchesSearch;
          element.style.display = matched ? "flex" : "none";

          // åœ¨åˆ—è¡¨ä¸­å‹•æ…‹æ›´æ–°å€åŸŸé¡¯ç¤ºæ–‡å­—
          const label = element.querySelector("label span");
          if (label) {
            label.innerHTML = `${element.getAttribute(
              "data-name"
            )}ï¼ˆè¦æ ¼:${element.getAttribute(
              "data-spec"
            )} / å–®ä½:${element.getAttribute("data-unit")} / å€åŸŸ:${
              areaField || "æœªåˆ†é¡"
            }ï¼‰`;
          }

          if (matched) matchedCategories.add(category);
        });

        sheetIds.forEach((sheet) => {
          expandStatus[sheet] = matchedCategories.has(sheet);
          updateSectionDisplay(sheet);
        });
      }

      // âœ… è¨‚å–®è¼¸å‡ºä¾åº—å®¶æ­£ç¢ºå€åŸŸåˆ†é¡
      function generateSummary() {
        const store = document.getElementById("store-select").value;
        if (!store) {
          alert("è«‹å…ˆé¸æ“‡åº—å®¶");
          return;
        }

        const orderDate = document.getElementById("order-date").value;
        const remark = document.getElementById("remark").value.trim();

        const areaGroups = {};
        const unselectedGroups = {};

        allItems.forEach(({ element }) => {
          if (element.style.display !== "flex") return;
          const pcsQty =
            parseInt(element.querySelector(".pcs-input").value, 10) || 0;
          const name = element.getAttribute("data-name");
          const unit = element.getAttribute("data-unit") || "";
          const area = element.getAttribute(`data-${store}`) || "æœªåˆ†é¡";
          const boxCount =
            parseInt(element.getAttribute("data-boxcount"), 10) || null;

          areaGroups[area] = areaGroups[area] || [];
          unselectedGroups[area] = unselectedGroups[area] || [];

          if (pcsQty > 0) {
            let finalText = "";
            if (boxCount) {
              const boxes = Math.floor(pcsQty / boxCount);
              const remainder = pcsQty % boxCount;
              if (boxes > 0) finalText += `${boxes}ç®± `;
              if (remainder > 0) finalText += `${remainder}${unit}`;
            } else {
              finalText += `${pcsQty}${unit}`;
            }
            areaGroups[area].push(`${name} ${finalText}`);
          } else {
            unselectedGroups[area].push(name);
          }
        });

        let summary = `${store}\nè¨‚è²¨æ—¥æœŸï¼š${orderDate}\n\n`;
        Object.keys(areaGroups).forEach((area) => {
          if (area === "ç„¡" || area === "æœªåˆ†é¡") return;
          summary += `${area}\n`;
          summary += areaGroups[area].length
            ? areaGroups[area].join("\n")
            : "ï¼ˆç„¡ï¼‰";
          summary += "\n\n";
        });

        if (remark) summary += `å‚™è¨»ï¼š\n${remark}\n\n`;

        let displayText = summary + "ğŸ“¦ æœªé¸æ“‡å“é …ï¼ˆåƒ…é¡¯ç¤ºï¼Œä¸è¤‡è£½ï¼‰ï¼š\n";
        Object.keys(unselectedGroups).forEach((area) => {
          if (area === "ç„¡" || area === "æœªåˆ†é¡") return;
          displayText += `${area}\n`;
          displayText += unselectedGroups[area].length
            ? unselectedGroups[area].join("\n")
            : "ï¼ˆç„¡ï¼‰";
          displayText += "\n\n";
        });

        const summaryEl = document.getElementById("order-summary");
        summaryEl.textContent = displayText;
        summaryEl.setAttribute("data-copy-text", summary);
        document.getElementById("copy-btn").style.display = "block";
        summaryEl.scrollIntoView({ behavior: "smooth" });
      }

      function copySummary() {
        const summaryEl = document.getElementById("order-summary");
        const textToCopy = summaryEl.getAttribute("data-copy-text") || "";
        if (!textToCopy) {
          alert("æ²’æœ‰è¨‚å–®å…§å®¹å¯è¤‡è£½ï¼");
          return;
        }
        navigator.clipboard.writeText(textToCopy).then(() => {
          alert("âœ… è¨‚å–®å…§å®¹å·²è¤‡è£½ï¼ˆå«å‚™è¨»ï¼‰ï¼");
        });
      }

      window.onload = () => {
        loadProducts();
        document
          .getElementById("scroll-top-btn")
          .addEventListener("click", () => {
            window.scrollTo({ top: 0, behavior: "smooth" });
          });
      };
    </script>
  </body>
</html>
