<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>è¨‚è²¨æ¸…å–®ï¼ˆåº—å®¶ç¯©é¸ï¼‰</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 700px;
        margin: auto;
        padding: 20px;
      }
      h2 {
        text-align: center;
      }
      label {
        display: block;
        margin-top: 15px;
      }
      select,
      input[type="date"],
      textarea {
        width: 100%;
        padding: 8px;
        margin-top: 6px;
        box-sizing: border-box;
      }
      h3 {
        margin-top: 30px;
        border-bottom: 1px solid #ccc;
        padding: 10px;
        cursor: pointer;
        background-color: #f2f2f2;
        user-select: none;
      }
      .item-list {
        padding: 10px 15px;
        display: none;
      }
      .item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
      }
      input[type="number"] {
        width: 60px;
        padding: 5px;
      }
      button {
        margin-top: 30px;
        width: 100%;
        padding: 12px;
        font-size: 18px;
      }
      #order-summary {
        white-space: pre-wrap;
        background: #eee;
        padding: 15px;
        margin-top: 20px;
        border-radius: 6px;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <h2>è¨‚è²¨å•†å“æ¸…å–®</h2>

    <label for="store-select">è«‹é¸æ“‡åº—å®¶ï¼š</label>
    <select id="store-select" onchange="filterItems()">
      <option value="">-- è«‹é¸æ“‡åº—å®¶ --</option>
      <option value="æ¼¢ç¥åº—">æ¼¢ç¥åº—</option>
      <option value="å·¨è›‹åº—">å·¨è›‹åº—</option>
    </select>

    <label for="order-date">è¨‚è²¨æ—¥æœŸï¼š</label>
    <input type="date" id="order-date" />

    <label for="remark">å‚™è¨»ï¼š</label>
    <textarea id="remark" rows="3" placeholder="è«‹è¼¸å…¥å‚™è¨»..."></textarea>

    <input
      type="text"
      id="search"
      placeholder="ğŸ” æœå°‹å•†å“åç¨±ã€è¦æ ¼ã€å–®ä½..."
      oninput="filterItems()"
    />

    <div id="product-list"></div>

    <button onclick="generateSummary()">å®Œæˆè¨‚å–®ä¸¦é¡¯ç¤ºå…§å®¹</button>

    <button onclick="copySummary()" style="display: none" id="copy-btn">
      è¤‡è£½è¨‚å–®å…§å®¹
    </button>

    <pre id="order-summary"></pre>

    <script>
      // Google Sheet åˆ†é åˆ—è¡¨ï¼Œè«‹æ ¹æ“šä½ éœ€æ±‚ä¿®æ”¹
      const sheetApiBase =
        "https://opensheet.vercel.app/1uzqHTQxyhYxTtU6SNbgme46i3rrjyUDfj4iq9IFQjFY/";
      const sheetIds = ["å†·å‡é¡", "å¸¸æº«/åŒ…æé¡", "æ–‡å…·é¡", "æ¸…æ½”ç”¨å“é¡"];

      let allItems = []; // {element, category}
      const expandStatus = {}; // ç´€éŒ„åˆ†é¡å±•é–‹ç‹€æ…‹

      // åˆå§‹åŒ–è¨‚è²¨æ—¥æœŸç‚ºä»Šå¤©
      document.getElementById("order-date").valueAsDate = new Date();

      async function loadProducts() {
        const container = document.getElementById("product-list");
        container.innerHTML = "";
        allItems = [];

        // åˆå§‹åŒ–å±•é–‹ç‹€æ…‹
        sheetIds.forEach((sheet) => (expandStatus[sheet] = false));

        for (const sheetName of sheetIds) {
          try {
            const encodedSheet = encodeURIComponent(sheetName);
            const res = await fetch(`${sheetApiBase}${encodedSheet}`);
            const data = await res.json();

            const section = document.createElement("section");
            const title = document.createElement("h3");
            title.textContent = sheetName;

            title.onclick = () => {
              expandStatus[sheetName] = !expandStatus[sheetName];
              updateSectionDisplay(sheetName);
            };

            const listDiv = document.createElement("div");
            listDiv.className = "item-list";

            data.forEach((item) => {
              const storeField = (item.åº—å®¶ || "").replace(/\s/g, "");
              // å•†å“åŒ…å«å±¬æ€§ï¼šname, è¦æ ¼, å–®ä½, åº—å®¶
              const div = document.createElement("div");
              div.className = "item";
              div.setAttribute("data-name", item.name || "");
              div.setAttribute("data-spec", item.è¦æ ¼ || "");
              div.setAttribute("data-unit", item.å–®ä½ || "");
              div.setAttribute("data-store", storeField);
              div.setAttribute("data-category", sheetName);

              div.innerHTML = `
            <label>
              <span>${item.name}ï¼ˆè¦æ ¼:${item.è¦æ ¼ || ""} / å–®ä½:${
                item.å–®ä½ || ""
              }ï¼‰</span>
              <input type="number" min="0" value="0" />
            </label>
          `;

              listDiv.appendChild(div);
              allItems.push({ element: div, category: sheetName });
            });

            section.appendChild(title);
            section.appendChild(listDiv);
            container.appendChild(section);

            updateSectionDisplay(sheetName);
          } catch (err) {
            const errorDiv = document.createElement("div");
            errorDiv.className = "error";
            errorDiv.innerText = `âŒ ç„¡æ³•è¼‰å…¥ã€Œ${sheetName}ã€ï¼Œè«‹æª¢æŸ¥åˆ†é åç¨±æˆ–ç¶²è·¯`;
            container.appendChild(errorDiv);
            console.error(`âŒ è¼‰å…¥éŒ¯èª¤ï¼š${sheetName}`, err);
          }
        }
      }

      function updateSectionDisplay(sheetName) {
        const section = [...document.querySelectorAll("section")].find(
          (sec) => sec.querySelector("h3").textContent === sheetName
        );
        if (!section) return;
        const listDiv = section.querySelector(".item-list");
        listDiv.style.display = expandStatus[sheetName] ? "block" : "none";
      }

      // ç¯©é¸é‚è¼¯çµåˆåº—å®¶èˆ‡æœå°‹
      function filterItems() {
        const store = document.getElementById("store-select").value.trim();
        const keyword = document.getElementById("search").value.toLowerCase();

        // ç¯©é¸ç¬¦åˆæ¢ä»¶çš„å•†å“ä¸¦é¡¯ç¤ºï¼Œä¸ç¬¦åˆå‰‡éš±è—
        const matchedCategories = new Set();

        allItems.forEach(({ element, category }) => {
          const storeField = element.getAttribute("data-store");
          const matchesStore = store
            ? storeField.split(",").includes(store)
            : true;

          const name = element.getAttribute("data-name").toLowerCase();
          const spec = element.getAttribute("data-spec").toLowerCase();
          const unit = element.getAttribute("data-unit").toLowerCase();

          const matchesSearch =
            name.includes(keyword) ||
            spec.includes(keyword) ||
            unit.includes(keyword);

          const matched = matchesStore && matchesSearch;

          element.style.display = matched ? "flex" : "none";

          if (matched) matchedCategories.add(category);
        });

        // è‡ªå‹•å±•é–‹æœ‰åŒ¹é…çš„åˆ†é¡ï¼Œæ”¶åˆæ²’æœ‰åŒ¹é…çš„
        sheetIds.forEach((sheet) => {
          expandStatus[sheet] = matchedCategories.has(sheet);
          updateSectionDisplay(sheet);
        });
      }

      // ç”¢ç”Ÿè¨‚å–®æ‘˜è¦
      function generateSummary() {
        const store = document.getElementById("store-select").value;
        if (!store) {
          alert("è«‹å…ˆé¸æ“‡åº—å®¶");
          return;
        }

        const orderDate = document.getElementById("order-date").value;
        const remark = document.getElementById("remark").value.trim();

        const selected = [];
        const unselected = [];

        // åªè™•ç†å¯è¦‹ä¸”æœ‰é¡¯ç¤ºçš„å•†å“
        allItems.forEach(({ element }) => {
          if (element.style.display === "flex") {
            const qtyInput = element.querySelector("input[type='number']");
            const qty = parseInt(qtyInput.value, 10) || 0;
            const name = element.getAttribute("data-name");
            const unit = element.getAttribute("data-unit") || "";

            if (qty > 0) {
              selected.push(`${name} x ${qty} ${unit}`);
            } else {
              unselected.push(name);
            }
          }
        });

        let summary = `åº—å®¶ï¼š${store}\n`;
        summary += `è¨‚è²¨æ—¥æœŸï¼š${orderDate}\n\n`;

        summary += "ğŸ›’ å·²é¸æ“‡å“é …ï¼š\n";
        summary += selected.length ? selected.join("\n") : "ï¼ˆç„¡ï¼‰";

        summary += "\n\nğŸ“¦ æœªé¸æ“‡å“é …ï¼š\n";
        summary += unselected.length ? unselected.join("\n") : "ï¼ˆç„¡ï¼‰";

        if (remark) {
          summary += `\n\nğŸ“ å‚™è¨»ï¼š\n${remark}`;
        }

        const summaryEl = document.getElementById("order-summary");
        summaryEl.textContent = summary;

        const copyBtn = document.getElementById("copy-btn");
        copyBtn.style.display = "block";
      }

      // è¤‡è£½æ‘˜è¦
      function generateSummary() {
        const store = document.getElementById("store-select").value;
        if (!store) {
          alert("è«‹å…ˆé¸æ“‡åº—å®¶");
          return;
        }

        const orderDate = document.getElementById("order-date").value;
        const remark = document.getElementById("remark").value.trim();

        const selected = [];
        const unselected = [];

        allItems.forEach(({ element }) => {
          if (element.style.display === "flex") {
            const qtyInput = element.querySelector("input[type='number']");
            const qty = parseInt(qtyInput.value, 10) || 0;
            const name = element.getAttribute("data-name");
            const unit = element.getAttribute("data-unit") || "";

            if (qty > 0) {
              selected.push(`${name} x ${qty} ${unit}`);
            } else {
              unselected.push(name);
            }
          }
        });

        let summary = `åº—å®¶ï¼š${store}\nè¨‚è²¨æ—¥æœŸï¼š${orderDate}\n\n`;

        summary += "è¨‚è²¨å“é …";
        summary += selected.length ? selected.join("\n") : "ï¼ˆç„¡ï¼‰";

        // æœªé¸å“é …åªåœ¨ç•«é¢é¡¯ç¤ºï¼Œä¸åŠ å…¥è¤‡è£½å…§å®¹
        let displayText = summary + "\n\nğŸ“¦ æœªé¸æ“‡å“é …ï¼ˆåƒ…é¡¯ç¤ºï¼Œä¸è¤‡è£½ï¼‰ï¼š\n";
        displayText += unselected.length ? unselected.join("\n") : "ï¼ˆç„¡ï¼‰";

        if (remark) {
          displayText += `\n\nğŸ“ å‚™è¨»ï¼š\n${remark}`;
        }

        const summaryEl = document.getElementById("order-summary");
        summaryEl.textContent = displayText;

        const copyBtn = document.getElementById("copy-btn");
        copyBtn.style.display = "block";

        // å°‡è¦è¤‡è£½çš„ç´”æ–‡å­—æ”¾åœ¨ä¸€å€‹éš±è—å±¬æ€§ï¼Œä¾›è¤‡è£½ä½¿ç”¨
        summaryEl.setAttribute("data-copy-text", summary);
      }

      function copySummary() {
        const summaryEl = document.getElementById("order-summary");
        const textToCopy = summaryEl.getAttribute("data-copy-text") || "";

        if (!textToCopy) {
          alert("æ²’æœ‰è¨‚å–®å…§å®¹å¯è¤‡è£½ï¼");
          return;
        }

        navigator.clipboard.writeText(textToCopy).then(() => {
          alert("å·²è¤‡è£½è¨‚å–®å…§å®¹ï¼");
        });
      }

      window.onload = loadProducts;
    </script>
  </body>
</html>
