<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FLM訂貨輔助工具</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 700px;
        margin: auto;
        padding: 20px;
      }
      h2 {
        text-align: center;
      }
      label {
        display: block;
        margin-top: 15px;
      }
      select,
      input[type="date"],
      textarea {
        width: 100%;
        padding: 8px;
        margin-top: 6px;
        box-sizing: border-box;
      }
      h3 {
        margin-top: 30px;
        border-bottom: 1px solid #ccc;
        padding: 10px;
        cursor: pointer;
        background-color: #f2f2f2;
        user-select: none;
      }
      .item-list {
        padding: 10px 15px;
        display: none;
      }
      .item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
      }
      input[type="number"] {
        width: 60px;
        padding: 5px;
      }
      button {
        margin-top: 30px;
        width: 100%;
        padding: 12px;
        font-size: 18px;
      }
      #order-summary {
        white-space: pre-wrap;
        background: #eee;
        padding: 15px;
        margin-top: 20px;
        border-radius: 6px;
        font-family: monospace;
      }
      .calc-box {
        margin-left: 10px;
        color: blue;
      }
    </style>
  </head>
  <body>
    <h2>FLM訂貨輔助工具</h2>

    <!-- 選擇店家 -->
    <label for="store-select">請選擇店家：</label>
    <select id="store-select" onchange="filterItems()">
      <option value="">-- 請選擇店家 --</option>
      <option value="漢神店">漢神店</option>
      <option value="巨蛋店">巨蛋店</option>
    </select>

    <label for="order-date">訂貨日期：</label>
    <input type="date" id="order-date" />

    <label for="remark">備註：</label>
    <textarea id="remark" rows="3" placeholder="請輸入備註..."></textarea>

    <input
      type="text"
      id="search"
      placeholder="🔍 搜尋商品名稱、規格、單位..."
      oninput="filterItems()"
    />

    <div id="product-list"></div>

    <button onclick="generateSummary()">完成訂單並顯示內容</button>

    <button onclick="copySummary()" style="display: none" id="copy-btn">
      複製訂單內容
    </button>

    <pre id="order-summary"></pre>

    <script>
      const sheetApiBase =
        "https://opensheet.vercel.app/1uzqHTQxyhYxTtU6SNbgme46i3rrjyUDfj4iq9IFQjFY/";
      const sheetIds = ["冷凍類", "常溫/包材類", "文具/其他類", "清潔用品類"];
      let allItems = [];
      const expandStatus = {};

      document.getElementById("order-date").valueAsDate = new Date();

      // -----------------------------
      // 載入商品資料
      // -----------------------------
      async function loadProducts() {
        const container = document.getElementById("product-list");
        container.innerHTML = "";
        allItems = [];
        sheetIds.forEach((sheet) => (expandStatus[sheet] = false));

        for (const sheetName of sheetIds) {
          try {
            const encodedSheet = encodeURIComponent(sheetName);
            const res = await fetch(`${sheetApiBase}${encodedSheet}`);
            const data = await res.json();

            const section = document.createElement("section");
            const title = document.createElement("h3");
            title.textContent = sheetName;

            title.onclick = () => {
              expandStatus[sheetName] = !expandStatus[sheetName];
              updateSectionDisplay(sheetName);
            };

            const listDiv = document.createElement("div");
            listDiv.className = "item-list";

            data.forEach((item) => {
              const storeField = (item.店家 || "").replace(/\s/g, "");
              const areaField = (item.區域 || "").replace(/\s/g, "");
              const boxCount = parseInt(item.箱入數, 10) || null;

              const div = document.createElement("div");
              div.className = "item";
              div.setAttribute("data-name", item.name || "");
              div.setAttribute("data-spec", item.規格 || "");
              div.setAttribute("data-unit", item.單位 || "");
              div.setAttribute("data-store", storeField);
              div.setAttribute("data-area", areaField);
              if (boxCount) div.setAttribute("data-boxcount", boxCount);
              div.setAttribute("data-category", sheetName);

              div.innerHTML = `
<label>
  <span>${item.name}（規格:${item.規格} / 單位:${item.單位 || ""} / 區域:${
                areaField || "未分類"
              }）</span><br>
  數量: <input type="number" min="0" value="0" class="pcs-input" style="width:80px">
  <span class="calc-box"></span>
</label>
`;

              const pcsInput = div.querySelector(".pcs-input");
              const calcSpan = div.querySelector(".calc-box");

              pcsInput.addEventListener("input", () => {
                const qty = parseInt(pcsInput.value, 10) || 0;
                if (boxCount) {
                  const boxes = Math.floor(qty / boxCount);
                  const remainder = qty % boxCount;
                  let text = "";
                  if (boxes > 0) text += `${boxes}箱 `;
                  if (remainder > 0) text += `${remainder}${item.單位}`;
                  calcSpan.textContent = text;
                } else {
                  calcSpan.textContent = qty > 0 ? `${qty}${item.單位}` : "";
                }
              });

              listDiv.appendChild(div);
              allItems.push({ element: div, category: sheetName });
            });

            section.appendChild(title);
            section.appendChild(listDiv);
            container.appendChild(section);
            updateSectionDisplay(sheetName);
          } catch (err) {
            const errorDiv = document.createElement("div");
            errorDiv.className = "error";
            errorDiv.innerText = `❌ 無法載入「${sheetName}」，請檢查分頁名稱或網路`;
            container.appendChild(errorDiv);
            console.error(`❌ 載入錯誤：${sheetName}`, err);
          }
        }
      }

      // -----------------------------
      // 展開收合分類
      // -----------------------------
      function updateSectionDisplay(sheetName) {
        const section = [...document.querySelectorAll("section")].find(
          (sec) => sec.querySelector("h3").textContent === sheetName
        );
        if (!section) return;
        const listDiv = section.querySelector(".item-list");
        listDiv.style.display = expandStatus[sheetName] ? "block" : "none";
      }

      // -----------------------------
      // 篩選商品（店家 + 搜尋）
      // -----------------------------
      function filterItems() {
        const store = document.getElementById("store-select").value.trim();
        const keyword = document.getElementById("search").value.toLowerCase();
        const matchedCategories = new Set();

        allItems.forEach(({ element, category }) => {
          const storeField = element.getAttribute("data-store");
          const name = element.getAttribute("data-name").toLowerCase();
          const spec = element.getAttribute("data-spec").toLowerCase();
          const unit = element.getAttribute("data-unit").toLowerCase();

          const matchesStore = store
            ? storeField.split(",").includes(store)
            : true;
          const matchesSearch =
            name.includes(keyword) ||
            spec.includes(keyword) ||
            unit.includes(keyword);

          const matched = matchesStore && matchesSearch;
          element.style.display = matched ? "flex" : "none";
          if (matched) matchedCategories.add(category);
        });

        sheetIds.forEach((sheet) => {
          expandStatus[sheet] = matchedCategories.has(sheet);
          updateSectionDisplay(sheet);
        });
      }

      // -----------------------------
      // 生成訂單摘要（依區域分組）
      // -----------------------------
      function generateSummary() {
        const store = document.getElementById("store-select").value;
        if (!store) {
          alert("請先選擇店家");
          return;
        }

        const orderDate = document.getElementById("order-date").value;
        const remark = document.getElementById("remark").value.trim();

        const areaGroups = {}; // 前場/後場分組
        const unselectedGroups = {};

        allItems.forEach(({ element }) => {
          if (element.style.display !== "flex") return;
          const pcsQty =
            parseInt(element.querySelector(".pcs-input").value, 10) || 0;
          const name = element.getAttribute("data-name");
          const unit = element.getAttribute("data-unit") || "";
          const area = element.getAttribute("data-area") || "未分類";
          const boxCount =
            parseInt(element.getAttribute("data-boxcount"), 10) || null;

          areaGroups[area] = areaGroups[area] || [];
          unselectedGroups[area] = unselectedGroups[area] || [];

          if (pcsQty > 0) {
            let finalText = "";
            if (boxCount) {
              const boxes = Math.floor(pcsQty / boxCount);
              const remainder = pcsQty % boxCount;
              if (boxes > 0) finalText += `${boxes}箱 `;
              if (remainder > 0) finalText += `${remainder}${unit}`;
            } else {
              finalText += `${pcsQty}${unit}`;
            }
            areaGroups[area].push(`${name} ${finalText}`);
          } else {
            unselectedGroups[area].push(name);
          }
        });

        let summary = `${store}\n訂貨日期：${orderDate}\n\n`;
        Object.keys(areaGroups).forEach((area) => {
          summary += `${area}\n`;
          summary += areaGroups[area].length
            ? areaGroups[area].join("\n")
            : "（無）";
          summary += "\n\n";
        });

        if (remark) summary += `備註：\n${remark}\n\n`;

        let displayText = summary + "📦 未選擇品項（僅顯示，不複製）：\n";
        Object.keys(unselectedGroups).forEach((area) => {
          displayText += `${area}\n`;
          displayText += unselectedGroups[area].length
            ? unselectedGroups[area].join("\n")
            : "（無）";
          displayText += "\n\n";
        });

        const summaryEl = document.getElementById("order-summary");
        summaryEl.textContent = displayText;
        summaryEl.setAttribute("data-copy-text", summary);
        document.getElementById("copy-btn").style.display = "block";
      }

      // -----------------------------
      // 複製訂單內容
      // -----------------------------
      function copySummary() {
        const summaryEl = document.getElementById("order-summary");
        const textToCopy = summaryEl.getAttribute("data-copy-text") || "";
        if (!textToCopy) {
          alert("沒有訂單內容可複製！");
          return;
        }
        navigator.clipboard.writeText(textToCopy).then(() => {
          alert("✅ 訂單內容已複製（含備註）！");
        });
      }

      window.onload = loadProducts;
    </script>
  </body>
</html>
