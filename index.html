<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FLMè¨‚è²¨è¼”åŠ©å·¥å…·</title>
    <style>
      /* ---------- åŸºæœ¬æ¨£å¼ ---------- */
      body {
        font-family: "Segoe UI", sans-serif;
        margin: 0;
        padding: 10px;
        background: #f9f9f9;
        -webkit-font-smoothing: antialiased;
      }
      .container {
        max-width: 700px;
        margin: auto;
        padding: 10px;
      }
      h2 {
        text-align: center;
        font-size: 24px;
        margin-bottom: 20px;
        color: #333;
      }
      label {
        display: block;
        margin-top: 15px;
        font-size: 16px;
        color: #555;
      }
      select,
      input[type="date"],
      input[type="number"],
      textarea,
      input[type="text"] {
        width: 100%;
        padding: 10px;
        margin-top: 6px;
        box-sizing: border-box;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 6px;
        background: #fff;
        transition: border-color 0.2s;
      }
      select:focus,
      input:focus,
      textarea:focus {
        border-color: #4a90e2;
        outline: none;
      }

      /* ---------- å€å¡Š/é …ç›® ---------- */
      h3 {
        margin-top: 30px;
        border-bottom: 1px solid #ccc;
        padding: 15px;
        cursor: pointer;
        background-color: #4a90e2;
        color: #fff;
        user-select: none;
        font-size: 18px;
        border-radius: 6px 6px 0 0;
      }
      .item-list {
        padding: 10px 0;
        display: none;
      }
      .item {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        align-items: center;
        background: #fff;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        transition: background 0.2s;
      }
      .item:hover {
        background: #e6f0ff;
      }
      .item label {
        display: flex;
        flex-direction: column;
        gap: 5px;
        width: 100%;
      }
      input[type="number"] {
        width: 100px;
        padding: 6px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      .calc-box {
        margin-left: 10px;
        color: #4a90e2;
        font-size: 14px;
      }

      /* ---------- åº•éƒ¨æŒ‰éˆ• ---------- */
      .button-container {
        position: fixed;
        bottom: 0;
        left: 50%;
        width: 100%;
        transform: translateX(-50%); /* æ°´å¹³ç½®ä¸­ */
        max-width: 700px;
        margin: auto;
        padding: 10px;
        background: #f9f9f9;
        display: flex;
        gap: 10px;
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.08);
        z-index: 999;
        box-sizing: border-box;
      }
      .button-container button {
        flex: 1;
        font-size: 18px;
        padding: 12px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        color: #fff;
        transition: background 0.2s, opacity 0.2s;
      }
      #complete-btn {
        background: linear-gradient(90deg, #4a90e2, #357abd);
      }
      #complete-btn:hover {
        background: linear-gradient(90deg, #357abd, #285c8a);
      }
      #copy-btn {
        background: linear-gradient(90deg, #50c878, #3ea864);
      }
      #copy-btn:hover {
        background: linear-gradient(90deg, #3ea864, #33714f);
      }
      #scroll-top-btn {
        flex: 0 0 60px;
        font-size: 18px;
        padding: 10px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        color: #fff;
        background: linear-gradient(90deg, #4a90e2, #357abd);
        transition: background 0.2s, transform 0.12s;
      }
      #scroll-top-btn:hover {
        transform: translateY(-2px);
      }

      /* ---------- è¨‚å–®è¼¸å‡º ---------- */
      #order-summary {
        white-space: pre-wrap;
        background: #fff;
        padding: 15px;
        margin-top: 20px;
        border-radius: 8px;
        font-family: monospace;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      /* ---------- loading overlayï¼ˆå…¨åŸŸï¼‰ ---------- */
      #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.92);
        display: none; /* é è¨­éš±è—ï¼šç”¨ show/hide æ§åˆ¶ */
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        font-size: 18px;
        color: #333;
      }
      .spinner {
        border: 6px solid #ddd;
        border-top: 6px solid #4a90e2;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 0.8s linear infinite;
        margin-bottom: 15px;
      }
      @keyframes spin {
        100% {
          transform: rotate(360deg);
        }
      }
      .disabled-all {
        pointer-events: none;
        opacity: 0.5;
      }

      /* ---------- æ‰‹æ©Ÿæ¨£å¼ ---------- */
      @media (max-width: 480px) {
        .item {
          flex-direction: column;
          align-items: flex-start;
        }
        input[type="number"] {
          width: 100%;
        }
        h2 {
          font-size: 20px;
        }
        h3 {
          font-size: 16px;
          padding: 12px;
        }
        .button-container {
          display: flex;
          flex-direction: row;
          justify-content: space-between;
          gap: 8px;
          position: fixed;
          bottom: 10px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(255, 255, 255, 0.95);
          padding: 10px;
          width: calc(100% - 20px);
          max-width: 700px;
          border-radius: 14px;
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
          z-index: 100;
        }

        .button-container button {
          flex: 1;
          font-size: 14px;
          padding: 10px;
          border-radius: 10px;
        }

        #scroll-top-btn {
          flex: 0 0 40px;
          width: 40px;
          height: 40px;
          font-size: 16px;
          padding: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>FLMè¨‚è²¨è¼”åŠ©å·¥å…·</h2>

      <label for="store-select">è«‹é¸æ“‡åº—å®¶ï¼š</label>
      <select id="store-select" aria-label="é¸æ“‡åº—å®¶">
        <option value="">-- è«‹é¸æ“‡åº—å®¶ --</option>
        <option value="æ¼¢ç¥åº—">æ¼¢ç¥åº—</option>
        <option value="å·¨è›‹åº—">å·¨è›‹åº—</option>
        <option value="å°ä¸­åº—">å°ä¸­åº—</option>
      </select>

      <label for="order-date">è¨‚è²¨æ—¥æœŸï¼š</label>
      <input type="date" id="order-date" />

      <label for="remark">å‚™è¨»ï¼š</label>
      <textarea id="remark" rows="3" placeholder="è«‹è¼¸å…¥å‚™è¨»..."></textarea>

      <input
        type="text"
        id="search"
        placeholder="ğŸ” æœå°‹å•†å“åç¨±ã€è¦æ ¼ã€å–®ä½..."
        aria-label="æœå°‹å•†å“"
      />

      <!-- å±•é–‹/æ”¶åˆå…¨éƒ¨æŒ‰éˆ• -->
      <div style="margin: 10px 0; text-align: right">
        <button
          id="expand-all-btn"
          style="padding: 6px 12px; margin-right: 6px"
        >
          å±•é–‹å…¨éƒ¨
        </button>
        <button id="collapse-all-btn" style="padding: 6px 12px">
          æ”¶åˆå…¨éƒ¨
        </button>
      </div>

      <div id="product-list"></div>

      <pre id="order-summary" aria-live="polite"></pre>
    </div>

    <div class="button-container">
      <button id="complete-btn">å®Œæˆè¨‚å–®ä¸¦é¡¯ç¤ºå…§å®¹</button>
      <button id="copy-btn" style="display: none">è¤‡è£½è¨‚å–®å…§å®¹</button>
      <button id="scroll-top-btn" title="å›åˆ°æœ€ä¸Šæ–¹">â¬†ï¸</button>
    </div>

    <!-- å…¨é  Loading -->
    <div id="loading-overlay" role="status" aria-hidden="true">
      <div class="spinner" aria-hidden="true"></div>
      <p id="loading-text">è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</p>
      <div style="margin-top: 12px">
        <button
          id="retry-all-btn"
          style="
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            background: #357abd;
            color: #fff;
            cursor: pointer;
            display: none;
          "
        >
          é‡è©¦å¤±æ•—åˆ†é 
        </button>
      </div>
    </div>

    <script>
      /*******************************************************************
       * FLM è¨‚è²¨å·¥å…·ï¼ˆæœ€ä½³åŒ–ï¼‹è¼‰å…¥ä¸­ä¿è­·ï¼‰
       * æ”¹å¯«é‡é»ï¼š
       * - å–®ä¸€ loadProductsï¼ˆä¸¦è¡Œ fetch + Promise.allï¼‰
       * - isLoading + å…¨é  loading overlay
       * - åœ¨è¼‰å…¥ä¸­é˜»æ­¢ filter/generate/copy
       * - æ“´å……éŒ¯èª¤é‡è©¦ï¼ˆé¡¯ç¤ºå¤±æ•—åˆ†é å¯é‡è©¦ï¼‰
       *******************************************************************/

      const sheetApiBase =
        "https://opensheet.vercel.app/1uzqHTQxyhYxTtU6SNbgme46i3rrjyUDfj4iq9IFQjFY/";
      const sheetIds = ["å†·å‡é¡", "å¸¸æº«/åŒ…æé¡", "æ–‡å…·/å…¶ä»–é¡", "æ¸…æ½”ç”¨å“é¡"];

      let allItems = []; // { element, category }
      const expandStatus = {};
      let isLoading = false;
      let failedSheets = []; // å„²å­˜ fetch å¤±æ•—çš„åˆ†é åç¨±

      // DOM
      const productListEl = document.getElementById("product-list");
      const loadingOverlay = document.getElementById("loading-overlay");
      const loadingText = document.getElementById("loading-text");
      const retryAllBtn = document.getElementById("retry-all-btn");
      const storeSelect = document.getElementById("store-select");
      const searchInput = document.getElementById("search");
      const expandAllBtn = document.getElementById("expand-all-btn");
      const collapseAllBtn = document.getElementById("collapse-all-btn");
      const completeBtn = document.getElementById("complete-btn");
      const copyBtn = document.getElementById("copy-btn");
      const scrollTopBtn = document.getElementById("scroll-top-btn");
      const orderSummaryEl = document.getElementById("order-summary");
      const orderDateInput = document.getElementById("order-date");
      const remarkInput = document.getElementById("remark");

      // é è¨­è¨‚è²¨æ—¥ç‚ºä»Šå¤©
      orderDateInput.valueAsDate = new Date();

      // ---------- Loading æ§åˆ¶ ----------
      function showLoading(text = "è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...") {
        isLoading = true;
        loadingText.textContent = text;
        loadingOverlay.style.display = "flex";
        loadingOverlay.setAttribute("aria-hidden", "false");
        document.body.classList.add("disabled-all");
      }
      function hideLoading() {
        isLoading = false;
        loadingOverlay.style.display = "none";
        loadingOverlay.setAttribute("aria-hidden", "true");
        document.body.classList.remove("disabled-all");
        retryAllBtn.style.display = "none";
      }

      // ---------- è¼‰å…¥ç”¢å“ï¼ˆä¸¦è¡Œï¼‰ ----------
      async function loadProducts(retryOnlyFailed = false) {
        // è‹¥æ­£åœ¨è¼‰å…¥ï¼Œè·³é
        if (isLoading) return;
        showLoading();

        productListEl.innerHTML = "";
        allItems = [];
        failedSheets = [];
        sheetIds.forEach((s) => (expandStatus[s] = false));

        // è¦è¼‰çš„ sheet åˆ—è¡¨ï¼ˆå¯åªé‡è©¦å¤±æ•—çš„ï¼‰
        const targets =
          retryOnlyFailed && failedSheets.length
            ? failedSheets.slice()
            : sheetIds.slice();

        // ä¸¦è¡Œ fetch
        const promises = targets.map((sheetName) =>
          fetch(`${sheetApiBase}${encodeURIComponent(sheetName)}`)
            .then((res) => {
              if (!res.ok) throw new Error(`HTTP ${res.status}`);
              return res.json();
            })
            .then((data) => ({ sheetName, data }))
            .catch((err) => ({ sheetName, error: err }))
        );

        const results = await Promise.all(promises);

        results.forEach(({ sheetName, data, error }) => {
          if (error || !Array.isArray(data)) {
            failedSheets.push(sheetName);
            console.error("âŒ è¼‰å…¥éŒ¯èª¤ï¼š", sheetName, error);
            // é¡¯ç¤ºéŒ¯èª¤å€å¡Šï¼ˆæœƒé¡¯ç¤ºåœ¨ product-list æœ€åº•ï¼‰
            const errDiv = document.createElement("div");
            errDiv.className = "error";
            errDiv.style.background = "#fff3f3";
            errDiv.style.border = "1px solid #ffb3b3";
            errDiv.style.padding = "12px";
            errDiv.style.borderRadius = "8px";
            errDiv.style.marginBottom = "10px";
            errDiv.textContent = `âŒ ç„¡æ³•è¼‰å…¥ã€Œ${sheetName}ã€ã€‚è«‹æª¢æŸ¥åˆ†é åç¨±æˆ–ç¶²è·¯ã€‚`;
            productListEl.appendChild(errDiv);
            return;
          }

          // æˆåŠŸå»ºç«‹ section
          const section = document.createElement("section");
          const title = document.createElement("h3");
          title.textContent = sheetName;
          title.addEventListener("click", () => {
            expandStatus[sheetName] = !expandStatus[sheetName];
            updateSectionDisplay(sheetName);
          });

          const listDiv = document.createElement("div");
          listDiv.className = "item-list";

          data.forEach((item) => {
            const boxCount = parseInt(item.ç®±å…¥æ•¸, 10) || null;
            const name = item.name || "";
            const spec = item.è¦æ ¼ || "";
            const unit = item.å–®ä½ || "";

            const div = document.createElement("div");
            div.className = "item";
            div.setAttribute("data-name", name);
            div.setAttribute("data-spec", spec);
            div.setAttribute("data-unit", unit);
            div.setAttribute("data-category", sheetName);
            div.setAttribute("data-boxcount", boxCount || "");

            // æŠŠå…¶ä»–æ¬„ä½ç•¶æˆåº—å®¶æ¬„ä½ï¼ˆä½ åŸæœ¬çš„é‚è¼¯ï¼‰
            Object.keys(item).forEach((key) => {
              if (!["id", "name", "è¦æ ¼", "å–®ä½", "ç®±å…¥æ•¸"].includes(key)) {
                div.setAttribute(`data-${key}`, item[key] || "ç„¡");
              }
            });

            div.innerHTML = `
              <label>
                <span>${escapeHtml(name)}ï¼ˆè¦æ ¼:${escapeHtml(
              spec
            )} / å–®ä½:${escapeHtml(unit)}ï¼‰</span><br>
                æ•¸é‡: <input type="number" min="0" value="0" class="pcs-input" style="width:80px">
                <span class="calc-box"></span>
              </label>
            `;

            const pcsInput = div.querySelector(".pcs-input");
            const calcSpan = div.querySelector(".calc-box");

            pcsInput.addEventListener("input", () => {
              const qty = parseInt(pcsInput.value, 10) || 0;
              let text = "";
              if (boxCount) {
                const boxes = Math.floor(qty / boxCount);
                const remainder = qty % boxCount;
                if (boxes > 0) text += `${boxes}ç®± `;
                if (remainder > 0) text += `${remainder}${unit}`;
              } else {
                if (qty > 0) text = `${qty}${unit}`;
              }
              calcSpan.textContent = text;
            });

            listDiv.appendChild(div);
            allItems.push({ element: div, category: sheetName });
          });

          section.appendChild(title);
          section.appendChild(listDiv);
          productListEl.appendChild(section);
          updateSectionDisplay(sheetName);
        });

        // è‹¥æœ‰å¤±æ•—çš„åˆ†é ï¼Œé¡¯ç¤ºé‡è©¦æŒ‰éˆ•
        if (failedSheets.length) {
          loadingText.textContent = `éƒ¨åˆ†åˆ†é è¼‰å…¥å¤±æ•—ï¼š${failedSheets.join(
            ", "
          )}`;
          retryAllBtn.style.display = "inline-block";
          retryAllBtn.textContent = `é‡è©¦ï¼š${failedSheets.length} å€‹å¤±æ•—åˆ†é `;
          retryAllBtn.onclick = () => {
            // åªé‡è©¦å¤±æ•—çš„åˆ†é 
            loadProducts(true);
          };
        } else {
          hideLoading();
        }

        // è‹¥æœ‰ä»»ä½•æˆåŠŸè¼‰å…¥çš„å…§å®¹ï¼Œé—œé–‰ loadingï¼ˆä»å…è¨±é‡è©¦å¤±æ•—åˆ†é ï¼‰
        if (!failedSheets.length) {
          hideLoading();
        } else {
          // å¦‚æœåŒæ™‚æœ‰æˆåŠŸèˆ‡å¤±æ•—åˆ†é ï¼Œä»è§£é™¤ç¦ç”¨ï¼Œè®“ä½¿ç”¨è€…èƒ½æ“ä½œå·²è¼‰å…¥éƒ¨åˆ†
          hideLoading();
          // ä½†æç¤º user æœ‰éƒ¨åˆ†åˆ†é å°šæœªæˆåŠŸ
          showPartialWarning();
        }
      }

      function showPartialWarning() {
        // åªåœ¨ overlay çŸ­æš«æé†’ï¼ˆä½¿ç”¨è€…å¯è‡ªè¡Œé‡è©¦ï¼‰
        loadingText.textContent = `éƒ¨åˆ†åˆ†é è¼‰å…¥å¤±æ•—ï¼ˆå¯æŒ‰é‡è©¦ï¼‰ã€‚å·²è¼‰å…¥é …ç›®å¯ç¹¼çºŒæ“ä½œã€‚`;
        retryAllBtn.style.display = "inline-block";
        // é¡¯ç¤ºä¸€ä¸‹å†è‡ªå‹•éš±è— overlayï¼ˆçŸ­æš«ï¼‰
        // ä½†æˆ‘å€‘å‰›æ‰å·²ç¶“ hideLoading()ï¼Œé€™è£¡åªæ˜¯ä¿ç•™é‡è©¦æŒ‰éˆ•çš„é¡¯ç¤ºæ§åˆ¶
      }

      // ---------- æ›´æ–°å€å¡Šé¡¯ç¤º ----------
      function updateSectionDisplay(sheetName) {
        const section = [...document.querySelectorAll("section")].find(
          (sec) =>
            sec.querySelector("h3") &&
            sec.querySelector("h3").textContent === sheetName
        );
        if (!section) return;
        const listDiv = section.querySelector(".item-list");
        listDiv.style.display = expandStatus[sheetName] ? "block" : "none";
      }

      function expandAll() {
        sheetIds.forEach((sheet) => {
          expandStatus[sheet] = true;
          updateSectionDisplay(sheet);
        });
      }
      function collapseAll() {
        sheetIds.forEach((sheet) => {
          expandStatus[sheet] = false;
          updateSectionDisplay(sheet);
        });
      }

      // ---------- æœå°‹ï¼ˆdebounceï¼‰ ----------
      function debounce(fn, wait = 200) {
        let t = null;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), wait);
        };
      }
      function filterItems() {
        if (isLoading) return; // è¼‰å…¥ä¸­ä¸è™•ç†
        const store = storeSelect.value.trim();
        const keyword = (searchInput.value || "").toLowerCase();
        const matchedCategories = new Set();

        allItems.forEach(({ element, category }) => {
          const areaField = (
            element.getAttribute(`data-${store}`) || "ç„¡"
          ).toLowerCase();
          const name = (element.getAttribute("data-name") || "").toLowerCase();
          const spec = (element.getAttribute("data-spec") || "").toLowerCase();
          const unit = (element.getAttribute("data-unit") || "").toLowerCase();

          const matchesStore = store
            ? areaField !== "ç„¡" && areaField !== "ç„¡"
            : true;
          const matchesSearch =
            !keyword ||
            name.includes(keyword) ||
            spec.includes(keyword) ||
            unit.includes(keyword);

          const matched = matchesStore && matchesSearch;
          element.style.display = matched ? "flex" : "none";

          // æ›´æ–°é¡¯ç¤ºï¼ˆå€åŸŸæ–‡å­—ï¼‰
          const label = element.querySelector("label span");
          if (label) {
            const areaLabel =
              areaField && areaField !== "ç„¡" ? areaField : "æœªåˆ†é¡";
            label.innerHTML = `${escapeHtml(
              element.getAttribute("data-name") || ""
            )}ï¼ˆè¦æ ¼:${escapeHtml(
              element.getAttribute("data-spec") || ""
            )} / å–®ä½:${escapeHtml(
              element.getAttribute("data-unit") || ""
            )} / å€åŸŸ:${escapeHtml(areaLabel)}`;
            label.innerHTML += `ï¼‰`;
          }

          if (matched) matchedCategories.add(category);
        });

        sheetIds.forEach((sheet) => {
          expandStatus[sheet] = matchedCategories.has(sheet);
          updateSectionDisplay(sheet);
        });
      }
      const debouncedFilter = debounce(filterItems, 180);

      // ---------- è¨‚å–®ç”¢ç”Ÿï¼ˆåŒ…å«æœªé¸å“é …ï¼‰ ----------
      function generateSummary() {
        if (isLoading) {
          alert("è³‡æ–™ä»åœ¨è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™å†è©¦ã€‚");
          return;
        }
        const store = storeSelect.value;
        if (!store) {
          alert("è«‹å…ˆé¸æ“‡åº—å®¶");
          return;
        }

        const orderDate = orderDateInput.value;
        const remark = (remarkInput.value || "").trim();

        const areaGroups = {};
        const unselectedGroups = {};

        allItems.forEach(({ element }) => {
          // è·³éè¢« filter éš±è—çš„ element
          if (element.style.display === "none") return;
          const pcsQty =
            parseInt(element.querySelector(".pcs-input").value, 10) || 0;
          const name = element.getAttribute("data-name") || "";
          const unit = element.getAttribute("data-unit") || "";
          const area = element.getAttribute(`data-${store}`) || "æœªåˆ†é¡";
          const boxCount =
            parseInt(element.getAttribute("data-boxcount"), 10) || null;

          areaGroups[area] = areaGroups[area] || [];
          unselectedGroups[area] = unselectedGroups[area] || [];

          if (pcsQty > 0) {
            let finalText = "";
            if (boxCount) {
              const boxes = Math.floor(pcsQty / boxCount);
              const remainder = pcsQty % boxCount;
              if (boxes > 0) finalText += `${boxes}ç®± `;
              if (remainder > 0) finalText += `${remainder}${unit}`;
            } else {
              finalText += `${pcsQty}${unit}`;
            }
            areaGroups[area].push(`${name} ${finalText}`);
          } else {
            unselectedGroups[area].push(name);
          }
        });

        let summary = `${store}\nè¨‚è²¨æ—¥æœŸï¼š${orderDate}\n\n`;
        Object.keys(areaGroups).forEach((area) => {
          if (area === "ç„¡" || area === "æœªåˆ†é¡") return;
          summary += `${area}\n`;
          summary += areaGroups[area].length
            ? areaGroups[area].join("\n")
            : "ï¼ˆç„¡ï¼‰";
          summary += "\n\n";
        });

        if (remark) summary += `å‚™è¨»ï¼š\n${remark}\n\n`;

        let displayText = summary + "ğŸ“¦ æœªé¸æ“‡å“é …ï¼ˆåƒ…é¡¯ç¤ºï¼Œä¸è¤‡è£½ï¼‰ï¼š\n";
        Object.keys(unselectedGroups).forEach((area) => {
          if (area === "ç„¡" || area === "æœªåˆ†é¡") return;
          displayText += `${area}\n`;
          displayText += unselectedGroups[area].length
            ? unselectedGroups[area].join("\n")
            : "ï¼ˆç„¡ï¼‰";
          displayText += "\n\n";
        });

        orderSummaryEl.textContent = displayText;
        orderSummaryEl.setAttribute("data-copy-text", summary);
        copyBtn.style.display = "inline-block";
        orderSummaryEl.scrollIntoView({ behavior: "smooth" });
      }

      function copySummary() {
        if (isLoading) {
          alert("è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è¤‡è£½");
          return;
        }
        const textToCopy = orderSummaryEl.getAttribute("data-copy-text") || "";
        if (!textToCopy) {
          alert("æ²’æœ‰è¨‚å–®å…§å®¹å¯è¤‡è£½ï¼");
          return;
        }
        navigator.clipboard
          .writeText(textToCopy)
          .then(() => {
            alert("âœ… è¨‚å–®å…§å®¹å·²è¤‡è£½ï¼ˆå«å‚™è¨»ï¼‰ï¼");
          })
          .catch(() => {
            alert("ç„¡æ³•ä½¿ç”¨å‰ªè²¼ç°¿ APIï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚");
          });
      }

      // ---------- å·¥å…·/ç¶å®šäº‹ä»¶ ----------
      function escapeHtml(str) {
        if (!str) return "";
        return String(str).replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[m])
        );
      }

      expandAllBtn.addEventListener("click", () => {
        if (isLoading) return;
        expandAll();
      });
      collapseAllBtn.addEventListener("click", () => {
        if (isLoading) return;
        collapseAll();
      });
      storeSelect.addEventListener("change", debouncedFilter);
      searchInput.addEventListener("input", debouncedFilter);
      completeBtn.addEventListener("click", generateSummary);
      copyBtn.addEventListener("click", copySummary);
      scrollTopBtn.addEventListener("click", () =>
        window.scrollTo({ top: 0, behavior: "smooth" })
      );

      // å¿«æ·éµï¼šæŒ‰ Enter åœ¨æœå°‹æ¡†æ™‚è§¸ç™¼ filterï¼ˆä½†ä»æœ‰ debounceï¼‰
      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          debouncedFilter();
        }
      });

      // ---------- åˆå§‹åŒ–è¼‰å…¥ ----------
      window.addEventListener("load", () => {
        loadProducts();
      });
    </script>
  </body>
</html>
